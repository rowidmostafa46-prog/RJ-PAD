<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø­Ø±ÙŠØ± | ÙØ®Ø± Ø§Ù„Ø±ÙˆØ§ÙŠØ§Øª Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #050505; --accent: #8b0000; --text: #e0e0e0; --card: #121212; --gold: #ffd700; }
        body { background-color: var(--bg); color: var(--text); font-family: 'Cairo', sans-serif; margin: 0; }
        header { background: linear-gradient(135deg, #000, var(--accent)); padding: 40px 20px; text-align: center; border-bottom: 4px solid var(--accent); }
        .logo { font-size: 3.5rem; font-weight: 900; letter-spacing: 10px; text-shadow: 0 0 20px #ff0000; }
        .container { max-width: 1200px; margin: auto; padding: 20px; }

        /* Ù‚Ø³Ù… Ø´Ø±Ø­ Ø§Ù„Ø±ÙØ¹ Ø§Ù„ØªÙØµÙŠÙ„ÙŠ */
        .tutorial-box { background: #1a1a1a; padding: 25px; border-radius: 15px; border: 1px solid var(--gold); margin-bottom: 30px; }
        .tutorial-box h3 { color: var(--gold); margin-top: 0; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .guide-content { display: flex; flex-direction: column; gap: 15px; }
        .guide-step { background: #222; padding: 15px; border-radius: 10px; border-right: 4px solid var(--gold); }
        .guide-step b { color: var(--gold); font-size: 1.1rem; display: block; margin-bottom: 5px; }
        .guide-step code { background: #000; padding: 2px 5px; color: #ff4d4d; border-radius: 4px; }

        /* ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù†Ø´Ø± */
        .publish-box { background: var(--card); padding: 30px; border-radius: 20px; border: 1px solid var(--accent); margin-bottom: 50px; display: none; }
        input, textarea { width: 100%; padding: 15px; margin: 10px 0; background: #1a1a1a; border: 1px solid #333; color: white; border-radius: 8px; box-sizing: border-box; font-family: 'Cairo'; }
        #submitBtn { background: var(--accent); color: white; border: none; padding: 15px; cursor: pointer; font-weight: bold; border-radius: 8px; width: 100%; font-size: 1.2rem; transition: 0.3s; }

        /* Ø´Ø¨ÙƒØ© Ø§Ù„Ø±ÙˆØ§ÙŠØ§Øª */
        .stories-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 30px; }
        .story-card { background: var(--card); border-radius: 15px; overflow: hidden; border: 1px solid #222; transition: 0.3s; }
        .story-cover { width: 100%; height: 400px; object-fit: cover; }
        .story-info { padding: 20px; }
        .btn-read { display: block; background: #ff4d4d; color: #fff; text-align: center; padding: 12px; text-decoration: none; font-weight: bold; border-radius: 8px; margin-top: 15px; }
        .delete-btn { background: transparent; color: #ff4444; border: 1px solid #444; padding: 5px; border-radius: 5px; cursor: pointer; width: 100%; margin-top: 10px; }

        #loginBtn { background: #fff; color: #000; padding: 12px 30px; border-radius: 30px; cursor: pointer; border: none; font-weight: 900; margin-top: 20px; }
    </style>
</head>
<body>

<header>
    <div class="logo">Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø­Ø±ÙŠØ±</div>
    <p>âš¡ Ù†Ù€Ø³Ù€Ø¬ Ø§Ù„ÙƒÙ€Ù„Ù…Ù€Ø§Øª.. ÙˆÙÙ€Ø®Ù€Ø± Ø§Ù„Ù€Ø±ÙˆØ§ÙŠÙ€Ø§Øª âš¡</p>
    <button id="loginBtn">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø¨Ø¯Ø¹ÙŠÙ† (Google)</button>
</header>

<div class="container">
    <div class="tutorial-box">
        <h3>ğŸš€ ÙƒÙŠÙ ØªÙ†Ø´Ø± Ø¹Ù…Ù„Ùƒ ÙÙŠ Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø­Ø±ÙŠØ±ØŸ</h3>
        <div class="guide-content">
            <div class="guide-step">
                <b>1ï¸âƒ£ Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ø£ÙˆÙ„Ù‰: Ø§Ù„Ø±ÙØ¹</b>
                Ø§ÙØªØ­ ØªØ·Ø¨ÙŠÙ‚ <b>Google Drive</b> ÙˆØ§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø¹Ù„Ø§Ù…Ø© <code>(+)</code> Ø«Ù… Ø§Ø±ÙØ¹ Ù…Ù„Ù Ø§Ù„Ù€ PDF Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ.
            </div>
            <div class="guide-step">
                <b>2ï¸âƒ£ Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ø«Ø§Ù†ÙŠØ©: Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙˆØµÙˆÙ„</b>
                Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø«Ù„Ø§Ø« Ù†Ù‚Ø§Ø· Ø¨Ø¬Ø§Ù†Ø¨ Ø§Ù„Ù…Ù„ÙØŒ Ø§Ø®ØªØ± <b>Manage Access</b>ØŒ ÙˆØ§Ø¬Ø¹Ù„ Ø§Ù„Ø®ÙŠØ§Ø± <b>"Anyone with the link"</b> Ù„Ø¶Ù…Ø§Ù† ÙØªØ­Ù‡ Ù„Ù„Ù‚Ø±Ø§Ø¡.
            </div>
            <div class="guide-step">
                <b>3ï¸âƒ£ Ø§Ù„Ø®Ø·ÙˆØ© Ø§Ù„Ø«Ø§Ù„Ø«Ø©: Ø§Ù„Ù†Ø´Ø±</b>
                Ø§Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø· ÙˆØ¶Ø¹Ù‡ ÙÙŠ Ø®Ø§Ù†Ø© "Ø±Ø§Ø¨Ø· Ù…Ù„Ù Ø§Ù„Ù€ PDF" Ø¨Ø§Ù„Ø£Ø³ÙÙ„. Ø³Ù†Ù‚ÙˆÙ… Ø¨Ù†Ø³Ø¬ Ø¹Ù…Ù„Ùƒ ÙÙŠ Ø§Ù„Ù…ÙƒØªØ¨Ø© ÙÙˆØ±Ø§Ù‹!
            </div>
        </div>
    </div>

    <div id="publishSection" class="publish-box">
        <h2 style="text-align:center; color: var(--accent);">ğŸ–‹ï¸ Ø§Ù†Ø´Ø± Ø±ÙˆØ§ÙŠØªÙƒ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</h2>
        <input type="text" id="title" placeholder="Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø±ÙˆØ§ÙŠØ©">
        <input type="text" id="cover" placeholder="Ø±Ø§Ø¨Ø· ØºÙ„Ø§Ù Ø§Ù„Ø±ÙˆØ§ÙŠØ©">
        <input type="text" id="pdfLink" placeholder="Ø±Ø§Ø¨Ø· Google Drive Ù„Ù„Ù…Ù„Ù">
        <textarea id="idea" rows="3" placeholder="Ù†Ø¨Ø°Ø© Ø¹Ù† Ø§Ù„Ø¹Ù…Ù„..."></textarea>
        <button id="submitBtn">ØªÙ€Ø¹Ù…ÙŠØ¯ ÙˆÙ†Ø´Ø± Ø§Ù„Ø¹Ù…Ù„ âš¡</button>
    </div>

    <div id="storiesContainer" class="stories-grid"></div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp, updateDoc, doc, increment, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCqosyyE5ievwHPrfa6oJL2FD7uAjY2Y5I",
        authDomain: "rj-pad.firebaseapp.com",
        projectId: "rj-pad",
        storageBucket: "rj-pad.firebasestorage.app",
        messagingSenderId: "160358264882",
        appId: "1:160358264882:web:c243cda30c359266ed4c2b"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth();
    const db = getFirestore(app);
    const provider = new GoogleAuthProvider();

    function fixDriveLink(url) {
        if (url.includes("drive.google.com")) {
            const match = url.match(/\/d\/([a-zA-Z0-9_-]+)/);
            if (match && match[1]) {
                return `https://drive.google.com/uc?export=view&id=${match[1]}`;
            }
        }
        return url;
    }

    document.getElementById('loginBtn').onclick = () => signInWithPopup(auth, provider);

    onAuthStateChanged(auth, (user) => {
        if (user) {
            document.getElementById('loginBtn').style.display = 'none';
            document.getElementById('publishSection').style.display = 'block';
        }
    });

    document.getElementById('submitBtn').onclick = async () => {
        const title = document.getElementById('title').value;
        const cover = document.getElementById('cover').value;
        let pdf = document.getElementById('pdfLink').value;
        const idea = document.getElementById('idea').value;

        if (title && cover && pdf && idea) {
            pdf = fixDriveLink(pdf);
            await addDoc(collection(db, "stories"), {
                title, cover, pdf, idea,
                author: auth.currentUser.displayName,
                authorId: auth.currentUser.uid,
                views: 0,
                createdAt: serverTimestamp()
            });
            alert("ØªÙ… Ø§Ù„Ù†Ø´Ø± ÙÙŠ Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø­Ø±ÙŠØ±!");
            location.reload();
        } else { alert("ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª!"); }
    };

    onSnapshot(query(collection(db, "stories"), orderBy("createdAt", "desc")), (snap) => {
        const container = document.getElementById('storiesContainer');
        container.innerHTML = '';
        snap.forEach((sDoc) => {
            const data = sDoc.data();
            const isOwner = auth.currentUser && auth.currentUser.uid === data.authorId;
            container.innerHTML += `
                <div class="story-card">
                    <img src="${data.cover}" class="story-cover" onerror="this.src='https://via.placeholder.com/400x600/000/fff?text=Silk+Library'">
                    <div class="story-info">
                        <h3>${data.title}</h3>
                        <p style="font-size:0.8rem; color:gray;">Ø§Ù„ÙƒØ§ØªØ¨: ${data.author}</p>
                        <div style="font-size:0.9rem; color:#bbb; height:45px; overflow:hidden;">${data.idea}</div>
                        <div style="margin-top:10px;">ğŸ‘ï¸ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø§Øª: ${data.views || 0}</div>
                        <a href="${data.pdf}" target="_blank" rel="noopener noreferrer" class="btn-read" onclick="window.safeView('${sDoc.id}')">ğŸ“– Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©</a>
                        ${isOwner ? `<button class="delete-btn" onclick="window.deleteStory('${sDoc.id}')">ğŸ—‘ï¸ Ø³Ø­Ø¨ Ø§Ù„Ø¹Ù…Ù„ Ù…Ù† Ø§Ù„Ù…ÙƒØªØ¨Ø©</button>` : ''}
                    </div>
                </div>`;
        });
    });

    window.safeView = async (id) => {
        const key = 'v_' + id;
        if (!sessionStorage.getItem(key)) {
            await updateDoc(doc(db, "stories", id), { views: increment(1) });
            sessionStorage.setItem(key, '1');
        }
    };

    window.deleteStory = async (id) => {
        if (confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø¹Ù…Ù„ Ù…Ù† Ù…ÙƒØªØ¨Ø© Ø§Ù„Ø­Ø±ÙŠØ±ØŸ")) { await deleteDoc(doc(db, "stories", id)); }
    };
</script>
</body>
</html>
